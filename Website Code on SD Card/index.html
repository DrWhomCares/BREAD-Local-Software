<!DOCTYPE html>
<html>
<head>
    <script src="plotly.js"></script>
</head>

<body onload="loadData()">

    <h1>BREAD Configuration and Controls</h1>
    <div style="display: flex">
        <button id="run" onclick="setRunning()">Start Logging Data</button>
        <button id="estop" onclick="setESTOP()" style="color: white; background-color: red;">E-STOP OFF</button>
        <div style="display: flex; flex-direction: column;">
            <button id="download-pyrolysis" onclick="downloadCSVFile('pyrolysis-data.csv', 'pyrolysis-data.csv')">Download Pyrolysis Data</button>
            <button id="delete-pyrolysis" ondblclick="clearPyrolysis()">Clear All Pyrolysis Data</button>
        </div>
        <div style="display: flex; flex-direction: column;">
            <button id="download-bio" onclick="downloadCSVFile('bioreactor-data.csv', 'bioreactor-data.csv')">Download Bioreactor Data</button>
            <button id="delete-bio" ondblclick="clearBioreactor()">Clear All Bioreactor Data</button>
        </div>
        <div style="display: flex; flex-direction: column;">
            <button id="download-chem" onclick="downloadCSVFile('chemreactor-data.csv', 'chemreactor-data.csv')">Download Chemreactor Data</button>
            <button id="delete-chem" ondblclick="clearChemreactor()">Clear All Chemreactor Data</button>
        </div>
        <button ondblclick="clearPyrolysis(); clearBioreactor(); clearChemreactor();">Clear All Data</button>
        <div style="display: flex">
            <p style="margin: 0; margin-left: 50px; margin-right: 10px">Connection to ESP32: </p>
            <div id="connection" style="height: 18px; width: 18px; background-color: red; border-radius: 50%"></div>
        </div>
    </div>
    
    <iframe name="target" style="display:none;"></iframe>
    <hr>

    <div id="pyrolysis">
        <h1>Pyrolysis Reactor</h1>

        <!-- Gauge area -->
        <div style="display: flex">
            <div>
                <div id="pyrolysis-thermo-gauge1"></div>
                <!-- <p>Status: ON/OFF (from slice) </p> -->
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="ps1" id="pyrolysis-thermo-gauge1-amount">
                    <button onclick="
                        pyrolysisGaugeInfo['pyrolysis-thermo-gauge1'].setpoint = document.getElementById('pyrolysis-thermo-gauge1-amount').value;
                        updatePyrolysisGauge('pyrolysis-thermo-gauge1');
                    ">Push Data</button>
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="pp1" id="pyrolysis-thermo-gauge1-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="pi1" id="pyrolysis-thermo-gauge1-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="pd1" id="pyrolysis-thermo-gauge1-kd">
                    <button onclick="">Push Data</button>
                </form>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge2"></div>
                <!-- <p>Status: ON/OFF (from slice) </p> -->
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="ps2" id="pyrolysis-thermo-gauge2-amount">
                    <button onclick="
                        pyrolysisGaugeInfo['pyrolysis-thermo-gauge2'].setpoint = document.getElementById('pyrolysis-thermo-gauge2-amount').value;
                        updatePyrolysisGauge('pyrolysis-thermo-gauge2');
                    ">Push Data</button>                
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="pp2" id="pyrolysis-thermo-gauge2-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="pi2" id="pyrolysis-thermo-gauge2-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="pd2" id="pyrolysis-thermo-gauge2-kd">
                    <button onclick="">Push Data</button>
                </form>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge3"></div>
                <!-- <p>Status: ON/OFF (from slice) </p> -->
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="ps3" id="pyrolysis-thermo-gauge3-amount">
                    <button onclick="
                        pyrolysisGaugeInfo['pyrolysis-thermo-gauge3'].setpoint = document.getElementById('pyrolysis-thermo-gauge3-amount').value;
                        updatePyrolysisGauge('pyrolysis-thermo-gauge3');
                    ">Push Data</button>    
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="pp3" id="pyrolysis-thermo-gauge3-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="pi3" id="pyrolysis-thermo-gauge3-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="pd3" id="pyrolysis-thermo-gauge3-kd">
                    <button onclick="">Push Data</button>
                </form>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge4"></div>
                <!-- <p>Status: ON/OFF (from slice) </p> -->
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="ps4" id="pyrolysis-thermo-gauge4-amount">
                    <button onclick="
                        pyrolysisGaugeInfo['pyrolysis-thermo-gauge4'].setpoint = document.getElementById('pyrolysis-thermo-gauge4-amount').value;
                        updatePyrolysisGauge('pyrolysis-thermo-gauge4');
                    ">Push Data</button>    
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="pp4" id="pyrolysis-thermo-gauge4-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="pi4" id="pyrolysis-thermo-gauge4-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="pd4" id="pyrolysis-thermo-gauge4-kd">
                    <button onclick="">Push Data</button>
                </form>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge5"></div>
                <!-- <p>Status: ON/OFF (from slice) </p> -->
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="ps5" id="pyrolysis-thermo-gauge5-amount">
                    <button onclick="
                        pyrolysisGaugeInfo['pyrolysis-thermo-gauge5'].setpoint = document.getElementById('pyrolysis-thermo-gauge5-amount').value;
                        updatePyrolysisGauge('pyrolysis-thermo-gauge5');
                    ">Push Data</button>    
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="pp5" id="pyrolysis-thermo-gauge5-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="pi5" id="pyrolysis-thermo-gauge5-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="pd5" id="pyrolysis-thermo-gauge5-kd">
                    <button onclick="">Push Data</button>
                </form>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge6"></div>
                <!-- <p>Status: ON/OFF (from slice) </p> -->
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="ps6" id="pyrolysis-thermo-gauge6-amount">
                    <button onclick="
                        pyrolysisGaugeInfo['pyrolysis-thermo-gauge6'].setpoint = document.getElementById('pyrolysis-thermo-gauge6-amount').value;
                        updatePyrolysisGauge('pyrolysis-thermo-gauge6');
                    ">Push Data</button>   
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="pp6" id="pyrolysis-thermo-gauge6-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="pi6" id="pyrolysis-thermo-gauge6-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="pd6" id="pyrolysis-thermo-gauge6-kd">
                    <button onclick="">Push Data</button>
                </form>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
        </div>

        <!-- Graph area -->
        <div id='pyrolysis-thermo-graph'></div>
        <label for="tracking-amount">Number of previous seconds to track: </label>
        <input type="number" id="pyrolysis-tracking-amount" name="tracking-amount">
        <button id="pyrolysis-tracking" onclick="setTracking('pyrolysis-tracking', 'pyrolysis-tracking-amount', 'pyrolysis-thermo-graph')">Track Data</button>

        <br><br><br><br>
    </div>

    <div id="bioreactor">
        <h1>Bioreactor</h1>
        <div id="bio-thermocouples" style="display: flex">
            <div id="bio-thermo-gauge1"></div>
            <div id="bio-thermo-gauge2"></div>
            <div>
                <div id="bio-thermo-graph" style="height: 350px; width: 1100px;"></div>
                <label>Number of previous seconds to track: </label>
                <input type="number" id="bio-thermo-tracking-amount">
                <button id="bio-thermo-tracking" onclick="setTracking('bio-thermo-tracking', 'bio-thermo-tracking-amount', 'bio-thermo-graph')">Track Data</button>        
            </div>
        </div>
       
        <div id="bio-ph" style="display: flex">
            <div>
                <div id="bio-ph-gauge1"></div>
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="bs1" id="bio-ph-gauge1-amount">
                    <button onclick="
                        bioGaugeInfo['bio-ph-gauge1'].setpoint = document.getElementById('bio-ph-gauge1-amount').value;
                        updateBioPhGauge('bio-ph-gauge1')
                    ">Push Data</button>    
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="bp1" id="bio-ph-gauge1-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="bi1" id="bio-ph-gauge1-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="bd1" id="bio-ph-gauge1-kd">
                    <br>
                    <button onclick="">Push Data</button>
                </form>
            </div>
            <div>
                <div id="bio-ph-gauge2"></div>
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="bs2" id="bio-ph-gauge2-amount">
                    <button onclick="
                        bioGaugeInfo['bio-ph-gauge2'].setpoint = document.getElementById('bio-ph-gauge2-amount').value;
                        updateBioPhGauge('bio-ph-gauge2')
                    ">Push Data</button>    
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="bp2" id="bio-ph-gauge2-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="bi2" id="bio-ph-gauge2-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="bd2" id="bio-ph-gauge2-kd">
                    <br>
                    <button onclick="">Push Data</button>
                </form>
            </div>
            <div>
                <div id="bio-ph-graph" style="height: 350px; width: 1100px;"></div>
                <label>Number of previous seconds to track: </label>
                <input type="number" id="bio-ph-tracking-amount">
                <button id="bio-ph-tracking" onclick="setTracking('bio-ph-tracking', 'bio-ph-tracking-amount', 'bio-ph-graph')">Track Data</button>        
            </div>
        </div>
        <div id="bio-oxygen" style="display: flex">
            <div id="bio-oxygen-gauge1"></div>
            <div id="bio-oxygen-gauge2"></div>
            <div>
                <div id="bio-oxygen-graph" style="height: 350px; width: 1100px;"></div>
                <label>Number of previous seconds to track: </label>
                <input type="number" id="bio-oxygen-tracking-amount">
                <button id="bio-oxygen-tracking" onclick="setTracking('bio-oxygen-tracking', 'bio-oxygen-tracking-amount', 'bio-oxygen-graph')">Track Data</button>        
            </div>
        </div>
        <div id="bio-turbidity" style="display: flex">
            <div id="bio-turbidity-gauge1"></div>
            <div id="bio-turbidity-gauge2"></div>
            <div>
                <div id="bio-turbidity-graph" style="height: 350px; width: 1100px;"></div>
                <label>Number of previous seconds to track: </label>
                <input type="number" id="bio-turbidity-tracking-amount">
                <button id="bio-turbidity-tracking" onclick="setTracking('bio-turbidity-tracking', 'bio-turbidity-tracking-amount', 'bio-turbidity-graph')">Track Data</button>        
            </div>
        </div>
        <div id="bio-motors-1" style="display: flex">
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-stirring-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm1" id="bio-stirring-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-stirring-gauge1-amount').value, 'bio-stirring-gauge1')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump1-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm2" id="bio-pump1-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump1-gauge1-amount').value, 'bio-pump1-gauge1')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump2-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm3" id="bio-pump2-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump2-gauge1-amount').value, 'bio-pump2-gauge1')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump3-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm4" id="bio-pump3-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump3-gauge1-amount').value, 'bio-pump3-gauge1')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump4-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm5" id="bio-pump4-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump4-gauge1-amount').value, 'bio-pump4-gauge1')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump5-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm6" id="bio-pump5-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump5-gauge1-amount').value, 'bio-pump5-gauge1')">Push Data</button>
            </form>
        </div>
        <div id="bio-motors-2" style="display: flex">
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-stirring-gauge2"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm7" id="bio-stirring-gauge2-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-stirring-gauge2-amount').value, 'bio-stirring-gauge2')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump1-gauge2"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm8" id="bio-pump1-gauge2-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump1-gauge2-amount').value, 'bio-pump1-gauge2')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump2-gauge2"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm9" id="bio-pump2-gauge2-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump2-gauge2-amount').value, 'bio-pump2-gauge2')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump3-gauge2"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm10" id="bio-pump3-gauge2-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump3-gauge2-amount').value, 'bio-pump3-gauge2')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump4-gauge2"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm11" id="bio-pump4-gauge2-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump4-gauge2-amount').value, 'bio-pump4-gauge2')">Push Data</button>
            </form>
            <form action="/form-submit" method="POST" target="target">
                <div id="bio-pump5-gauge2"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="bm12" id="bio-pump5-gauge2-amount">
                <button onclick="setGaugeValue(document.getElementById('bio-pump5-gauge2-amount').value, 'bio-pump5-gauge2')">Push Data</button>
            </form>
        </div>
    </div>

    <div id="chemreactor">
        <h1>Chemreactor</h1>
        <div id="chem-thermocouple" style="display: flex">
            <form action="/form-submit" method="POST" target="target">
                <div id="chem-pump1-gauge1"></div>
                <label>Setpoint:</label>
                <input type="number" step="0.01" name="cm1" id="chem-pump1-gauge1-amount">
                <button onclick="setGaugeValue(document.getElementById('chem-pump1-gauge1-amount').value, 'chem-pump1-gauge1')">Push Data</button>
            </form>
            <div>
                <div id="chem-thermo-gauge1"></div>
                <form action="/form-submit" method="POST" target="target">
                    <label>Setpoint:</label>
                    <input type="number" step="0.01" name="cs1" id="chem-thermo-gauge1-amount">
                    <button onclick="
                       chemGaugeInfo['chem-thermo-gauge1'].setpoint = document.getElementById('chem-thermo-gauge1-amount').value
                       updateChemGauge('chem-thermo-gauge1')
                    ">Push Data</button>   
                </form>
                <br>
                <form action="/form-submit" method="POST" target="target">
                    <label>Kp:</label>
                    <input type="number" step="0.01" name="cp1" id="chem-thermo-gauge1-kp">
                    <br>
                    <label>Ki:</label>
                    <input type="number" step="0.01" name="ci1" id="chem-thermo-gauge1-ki">
                    <br>
                    <label>Kd:</label>
                    <input type="number" step="0.01" name="cd1" id="chem-thermo-gauge1-kd">
                    <button onclick="">Push Data</button>
                </form>
            </div>
            <div>
                <div id="chem-thermo-graph" style="height: 350px; width: 1100px;"></div>
                <label>Number of previous seconds to track: </label>
                <input type="number" id="chem-thermo-tracking-amount">
                <button id="chem-thermo-tracking" onclick="setTracking('chem-thermo-tracking', 'chem-thermo-tracking-amount', 'chem-thermo-graph')">Track Data</button>        
            </div>
        </div>
    </div>

<script>

//----------------Pyrolysis thermocouple traces-----------------------//  
var pyrolysis_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Condenser 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Condenser 2"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Condenser 0"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Char Chamber"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Dissolution Tank"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Valve"
    },
]

//----------------Bioreactor thermocouple traces-----------------------//
var bio_thermo_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Thermocouple 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Thermocouple 2"
    }
]

//----------------Bioreactor pH traces-----------------------//
var bio_ph_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "pH Sensor 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "pH Sensor 2"
    }
]

//----------------Bioreactor dissolved oxygen traces-----------------------//
var bio_oxygen_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Dissolved O2 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Dissolved O2 2"
    }
]

//----------------Bioreactor turbidity traces-----------------------//
var bio_turbidity_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Turbidity 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Turbidity 2"
    }
]

//----------------Chemreactor thermocouple traces-----------------------//
var chem_thermo_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Thermocouple"
    }
]

//----------------Thermocouple graph layout-----------------------//
var thermocouple_layout = {
    title: 'Temperature Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Degrees Celsius'
    },
    showlegend: true
};

var bio_thermo_layout = {
    title: 'Temperature Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Degrees Celsius'
    },
    showlegend: true
};

var chem_thermo_layout = {
    title: 'Temperature Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Degrees Celsius'
    },
    showlegend: true
};

//----------------pH graph layout-----------------------//
var pH_layout = {
    title: 'pH Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'pH'
    },
    showlegend: true
};

//----------------Dissolved oxygen graph layout-----------------------//
var oxygen_layout = {
    title: 'Dissolved Oxygen Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Dissolved Oxygen (mL)'
    },
    showlegend: true
};

//----------------Turbidity graph layout-----------------------//
var turbidity_layout = {
    title: 'Turbidity Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Turbidity (NTU)'
    },
    showlegend: true
};

//----------------Standard Gauge Layout-----------------------//
var gaugeLayout = { width: 270, height: 220, margin: { t: 0, b: 0, l: 40, r: 40} };

//----------------Thermocouple Gauge-----------------------//
var thermo_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 200 },
    gauge: {
        axis: { range: [null, 400] },
        bar: { color: "blue" },
        steps: [
            { range: [0, 400], color: "#dddddd" },
            { range: [145, 155], color: "yellow" },
            { range: [195, 205], color: "green" },
            { range: [245, 255], color: "red" }
        ],
    }
}];

var thermo_bio_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 200 },
    gauge: {
        axis: { range: [null, 400] },
        bar: { color: "blue" },
        steps: [
            { range: [0, 400], color: "#dddddd" },
        ],
    }
}];

//----------------pH Gauge-----------------------//
var pH_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 7},
    number: {'valueformat':'f'},
    gauge: {
        axis: { range: [null, 14] },
        bar: { color: "green" },
        steps: [
            { range: [0, 14], color: "#dddddd" },
        ],
        threshold: {
            line: { color: "red", width: 4 },
            thickness: 0.75,
            value: 7
        }
    }
}];

//----------------Dissolved Oxygen Gauge-----------------------//
var oxygen_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 50 },
    gauge: {
        axis: { range: [null, 100] },
        bar: { color: "green" },
        steps: [
            { range: [0, 100], color: "#dddddd" },
        ],
    }
}];

//----------------Turbidity Gauge-----------------------//
var turbidity_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 1 },
    gauge: {
        axis: { range: [null, 6] },
        bar: { color: "green" },
        steps: [
            { range: [0, 6], color: "#dddddd" },
        ],
    }
}];

//----------------Motor Gauge-----------------------//
var motor_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 50 },
    gauge: {
        axis: { range: [null, 100] },
        bar: { color: "green" },
        steps: [
            { range: [0, 100], color: "#dddddd" },
        ],
    }
}];

//----------------Pyrolysis Gauges-----------------------//
var pyrolysisGaugeInfo = {
    "pyrolysis-thermo-gauge1": {
        title: "Condenser 1",
        setpoint: 200,
        value: 0,
    },
    "pyrolysis-thermo-gauge2": {
        title: "Condenser 2",
        setpoint: 200,
        value: 0,
    },
    "pyrolysis-thermo-gauge3": {
        title: "Condenser 0",
        setpoint: 200,
        value: 0,
    },
    "pyrolysis-thermo-gauge4": {
        title: "Char Chamber",
        setpoint: 200,
        value: 0,
    },
    "pyrolysis-thermo-gauge5": {
        title: "Dissolution Tank",
        setpoint: 200,
        value: 0,
    },
    "pyrolysis-thermo-gauge6": {
        title: "Valve",
        setpoint: 200,
        value: 0,
    },
}

//create new gauge plots
Plotly.newPlot('pyrolysis-thermo-gauge1', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge2', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge3', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge4', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge5', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge6', thermo_gauge, gaugeLayout);

//adjust titles
Plotly.restyle('pyrolysis-thermo-gauge1', {title: pyrolysisGaugeInfo['pyrolysis-thermo-gauge1'].title})
Plotly.restyle('pyrolysis-thermo-gauge2', {title: pyrolysisGaugeInfo['pyrolysis-thermo-gauge2'].title})
Plotly.restyle('pyrolysis-thermo-gauge3', {title: pyrolysisGaugeInfo['pyrolysis-thermo-gauge3'].title})
Plotly.restyle('pyrolysis-thermo-gauge4', {title: pyrolysisGaugeInfo['pyrolysis-thermo-gauge4'].title})
Plotly.restyle('pyrolysis-thermo-gauge5', {title: pyrolysisGaugeInfo['pyrolysis-thermo-gauge5'].title})
Plotly.restyle('pyrolysis-thermo-gauge6', {title: pyrolysisGaugeInfo['pyrolysis-thermo-gauge6'].title})

//----------------Bioreactor Gauges-----------------------//
var bioGaugeInfo = {
    "bio-thermo-gauge1": {
        title: "Thermocouple 1",
        value: 0,
    },
    "bio-ph-gauge1": {
        title: "pH Sensor 1",
        value: 0,
        setpoint: 0,
    },
    "bio-oxygen-gauge1": {
        title: "Dissolved Oxygen 1",
        value: 0,
    },
    "bio-turbidity-gauge1": {
        title: "Turbidity 1",
        value: 0,
    },
    "bio-thermo-gauge2": {
        title: "Thermocouple 2",
        value: 0,
    },
    "bio-ph-gauge2": {
        title: "pH Sensor 2",
        value: 0,
        setpoint: 0,
    },
    "bio-oxygen-gauge2": {
        title: "Dissolved Oxygen 2",
        value: 0,
    },
    "bio-turbidity-gauge2": {
        title: "Turbidity 2",
        value: 0,
    },
}
var motorGaugeInfo = {
    "bio-stirring-gauge1": {
        title: "Stirring Motor 1",
    },
    "bio-pump1-gauge1": {
        title: "Sampling Pump 1",
    },
    "bio-pump2-gauge1": {
        title: "Media Pump 1",
    },
    "bio-pump3-gauge1": {
        title: "Acid Pump 1",
    },
    "bio-pump4-gauge1": {
        title: "Base Pump 1",
    },
    "bio-pump5-gauge1": {
        title: "Pump 1-5",
    },
    "bio-stirring-gauge2": {
        title: "Stirring Motor 2",
    },
    "bio-pump1-gauge2": {
        title: "Sampling Pump 2",
    },
    "bio-pump2-gauge2": {
        title: "Media Pump 2",
    },
    "bio-pump3-gauge2": {
        title: "Acid Pump 2",
    },
    "bio-pump4-gauge2": {
        title: "Base Pump 2",
    },
    "bio-pump5-gauge2": {
        title: "Pump 2-5",
    },
    "chem-pump1-gauge1": {
        title: "Pump 1"
    }
}
//create new gauge plots
Plotly.newPlot('bio-thermo-gauge1', thermo_bio_gauge, gaugeLayout);
Plotly.newPlot('bio-thermo-gauge2', thermo_bio_gauge, gaugeLayout);

Plotly.newPlot('bio-ph-gauge1', pH_gauge, gaugeLayout);
Plotly.newPlot('bio-ph-gauge2', pH_gauge, gaugeLayout);

Plotly.newPlot('bio-oxygen-gauge1', oxygen_gauge, gaugeLayout);
Plotly.newPlot('bio-oxygen-gauge2', oxygen_gauge, gaugeLayout);

Plotly.newPlot('bio-turbidity-gauge1', turbidity_gauge, gaugeLayout);
Plotly.newPlot('bio-turbidity-gauge2', turbidity_gauge, gaugeLayout);

Plotly.newPlot("bio-stirring-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-stirring-gauge2", motor_gauge, gaugeLayout);

Plotly.newPlot("bio-pump1-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump2-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump3-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump4-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump5-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump1-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump2-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump3-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump4-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump5-gauge2", motor_gauge, gaugeLayout);

//restyle
Plotly.restyle('bio-thermo-gauge1', {title: bioGaugeInfo["bio-thermo-gauge1"].title})
Plotly.restyle('bio-thermo-gauge2', {title: bioGaugeInfo["bio-thermo-gauge2"].title})
Plotly.restyle('bio-ph-gauge1', {title: bioGaugeInfo["bio-ph-gauge1"].title})
Plotly.restyle('bio-ph-gauge2', {title: bioGaugeInfo["bio-ph-gauge2"].title})
Plotly.restyle('bio-oxygen-gauge1', {title: bioGaugeInfo["bio-oxygen-gauge1"].title})
Plotly.restyle('bio-oxygen-gauge2', {title: bioGaugeInfo["bio-oxygen-gauge2"].title})
Plotly.restyle('bio-turbidity-gauge1', {title: bioGaugeInfo["bio-turbidity-gauge1"].title})
Plotly.restyle('bio-turbidity-gauge2', {title: bioGaugeInfo["bio-turbidity-gauge2"].title})

Plotly.restyle("bio-stirring-gauge1", {title: motorGaugeInfo["bio-stirring-gauge1"].title})
Plotly.restyle("bio-stirring-gauge2", {title: motorGaugeInfo["bio-stirring-gauge2"].title})

Plotly.restyle("bio-pump1-gauge1", {title: motorGaugeInfo["bio-pump1-gauge1"].title})
Plotly.restyle("bio-pump2-gauge1", {title: motorGaugeInfo["bio-pump2-gauge1"].title})
Plotly.restyle("bio-pump3-gauge1", {title: motorGaugeInfo["bio-pump3-gauge1"].title})
Plotly.restyle("bio-pump4-gauge1", {title: motorGaugeInfo["bio-pump4-gauge1"].title})
Plotly.restyle("bio-pump5-gauge1", {title: motorGaugeInfo["bio-pump5-gauge1"].title})

Plotly.restyle("bio-pump1-gauge2", {title: motorGaugeInfo["bio-pump1-gauge2"].title})
Plotly.restyle("bio-pump2-gauge2", {title: motorGaugeInfo["bio-pump2-gauge2"].title})
Plotly.restyle("bio-pump3-gauge2", {title: motorGaugeInfo["bio-pump3-gauge2"].title})
Plotly.restyle("bio-pump4-gauge2", {title: motorGaugeInfo["bio-pump4-gauge2"].title})
Plotly.restyle("bio-pump5-gauge2", {title: motorGaugeInfo["bio-pump5-gauge2"].title})

//----------------Chemreactor Gauges-----------------------//
var chemGaugeInfo = {
    "chem-thermo-gauge1": {
        title: "Thermocouple",
        value: 0,
        setpoint: 0
    }
}
Plotly.newPlot("chem-thermo-gauge1", thermo_gauge, gaugeLayout);
Plotly.newPlot("chem-pump1-gauge1", motor_gauge, gaugeLayout);

Plotly.restyle('chem-thermo-gauge1', {title: chemGaugeInfo["chem-thermo-gauge1"].title})
Plotly.restyle('chem-pump1-gauge1', {title: motorGaugeInfo["chem-pump1-gauge1"].title})

//--------------------------------------------------------------------------//

function loadData() {
    //Get Data	
    fetch('pyrolysis-data.csv')
    .then(response => response.text())
    .then(text => {
        let row = text.split("\r\n") //split entries by row

        for(let n = 1; n < row.length; n++) {
            let data = row[n].split(',')
            for(let x = 0; x < pyrolysis_traces.length; x++) {
                pyrolysis_traces[x].x.push(data[0])     //data[0] pushes time to the x axis
                pyrolysis_traces[x].y.push(data[x+1])   //data[x+1] to avoid pushing the date and time
            }
        }

        //Plot data
        Plotly.newPlot('pyrolysis-thermo-graph', pyrolysis_traces, thermocouple_layout, {scrollZoom: true});                                
    })

    //load bioreactor data
    fetch('bioreactor-data.csv')
    .then(response => response.text())
    .then(text => {
        let row = text.split("\r\n") //split entries by row

        for(let n = 1; n < row.length; n++) {
            let data = row[n].split(',')
            for(let x = 0; x < 2; x++) {
                bio_thermo_traces[x].x.push(data[0])    //data[0] pushes time to the x axis
                bio_ph_traces[x].x.push(data[0])        
                bio_oxygen_traces[x].x.push(data[0])
                bio_turbidity_traces[x].x.push(data[0])
                
                bio_thermo_traces[x].y.push(data[x*4+1]) 
                bio_ph_traces[x].y.push(data[x*4+2])    
                bio_oxygen_traces[x].y.push(data[x*4+3]) 
                bio_turbidity_traces[x].y.push(data[x*4+4]) 
            }
        }

        //Plot data
        Plotly.newPlot('bio-thermo-graph', bio_thermo_traces, bio_thermo_layout, {scrollZoom: true});                    
        Plotly.newPlot('bio-ph-graph', bio_ph_traces, pH_layout, {scrollZoom: true});
        Plotly.newPlot('bio-oxygen-graph', bio_oxygen_traces, oxygen_layout, {scrollZoom: true});
        Plotly.newPlot('bio-turbidity-graph', bio_turbidity_traces, turbidity_layout, {scrollZoom: true});
    })

    //load chemreactor data
    fetch('chemreactor-data.csv')
    .then(response => response.text())
    .then(text => {
        let row = text.split("\r\n") //split entries by row
        for(let n = 1; n < row.length; n++) {
            let data = row[n].split(',')
            chem_thermo_traces[0].x.push(data[0])
            chem_thermo_traces[0].y.push(data[1])
        }
        Plotly.newPlot('chem-thermo-graph', chem_thermo_traces, chem_thermo_layout, {scrollZoom: true});
    })


    //send time to ESP32
    var now = new Date();
    var rtcTime = now.toLocaleTimeString('en-US', {hour12: false}).split(":")
    rtcTime[2] = parseInt(rtcTime[2])
    var rtcDate = now.toLocaleDateString().split("/")
    fetch(window.location.href + "get-variables", {
        method: "POST",
        headers: {
        'Content-Type': 'text/plain',
        },
        body: rtcTime[2]+","+rtcTime[1]+","+rtcTime[0]+","+rtcDate[1]+","+rtcDate[0]+","+rtcDate[2],
    })
    .then(response => response.text()) // Get the response as text
    .then(textData => {
        let sections = textData.split('-')
        if(sections[0] == "logging") {
            logging = true;
            document.getElementById("run").textContent = "Logging Data..."
        } else if(sections[0] == "not logging") {
            logging = false;
            document.getElementById("run").textContent = "Start Logging Data"
        }

        let pyrolysis = sections[1].split(',')
        for(let x = 0; x < pyrolysis.length; x++) {
            //p[0] setpoint, p[1] Kp, p[2] Ki, p[3] Kd
            let p = pyrolysis[x].split('|')
            let id = "pyrolysis-thermo-gauge" + (x+1)
            document.getElementById(id + "-amount").value = p[0]
            pyrolysisGaugeInfo[id].setpoint = p[0]
            document.getElementById(id + "-kp").value = p[1]
            document.getElementById(id + "-ki").value = p[2]
            document.getElementById(id + "-kd").value = p[3]
            updatePyrolysisGauge(id)
        }

        let bioPh = sections[2].split(',')
        for(let x = 0; x < bioPh.length; x++) {
            let b = bioPh[x].split('|')
            let id = "bio-ph-gauge" + (x+1)
            document.getElementById(id + "-amount").value = b[0]
            bioGaugeInfo[id].setpoint = b[0]
            document.getElementById(id + "-kp").value = b[1]
            document.getElementById(id + "-ki").value = b[2]
            document.getElementById(id + "-kd").value = b[3]
            updateBioPhGauge(id)
        }

        let bio = sections[3].split(',')
        document.getElementById("bio-stirring-gauge1-amount").value = bio[0]
        document.getElementById("bio-stirring-gauge2-amount").value = bio[6]
        Plotly.restyle('bio-stirring-gauge1', {title: motorGaugeInfo["bio-stirring-gauge1"].title, value: bio[0]})
        Plotly.restyle('bio-stirring-gauge2', {title: motorGaugeInfo["bio-stirring-gauge2"].title, value: bio[6]})
        for(let x = 0; x < 5; x++) {
            let id = "bio-pump" + (x+1) + "-gauge1" 
            document.getElementById(id + "-amount").value = bio[x+1]
            Plotly.restyle(id, {title: motorGaugeInfo[id].title, value: bio[x+1]})
        }
        for(let x = 0; x < 5; x++) {
            let id = "bio-pump" + (x+1) + "-gauge2"
            document.getElementById(id + "-amount").value = bio[x+7]
            Plotly.restyle(id, {title: motorGaugeInfo[id].title, value: bio[x+7]})
        }

        let chem = sections[4].split(',')
        document.getElementById("chem-pump1-gauge1-amount").value = parseInt(chem[0])
        Plotly.restyle('chem-pump1-gauge1', {title: "Pump 1", value: parseInt(chem[0])})
        let chemThermo = chem[1].split('|')
        let id = "chem-thermo-gauge1"
        document.getElementById(id + "-amount").value = chemThermo[0]
        chemGaugeInfo[id].setpoint = chemThermo[0]
        document.getElementById(id + "-kp").value = chemThermo[1]
        document.getElementById(id + "-ki").value = chemThermo[2]
        document.getElementById(id + "-kd").value = chemThermo[3]
        updateChemGauge(id)
        
    })
}

var pUpdateCounter = 6;
var bUpdateCounter = 6;
var cUpdateCounter = 6;
if (!!window.EventSource) {
    var source = new EventSource('/events');

    source.addEventListener('open', function(e) {
        console.log("Events Connected");
        document.getElementById("connection").style.backgroundColor = "green"; // Change this to the desired color when connected
    }, false);

    source.addEventListener('error', function(e) {
        if (e.target.readyState != EventSource.OPEN) {
            console.log("Events Disconnected");
            document.getElementById("connection").style.backgroundColor = "red"; // Change this to the desired color when disconnected
        }
    }, false);

    source.addEventListener('pyrolysis-readings', function(e) {
        var pyrolysisVals = e.data.split(',')
        
        let ids = Object.keys(pyrolysisGaugeInfo)
        ids.forEach((id) => {
            pyrolysisGaugeInfo[id].value = pyrolysisVals[ids.indexOf(id)+1]
            updatePyrolysisGauge(id)
        })
        
        //plot values
        if(logging) {
            pUpdateCounter += 1
            //could use a for loop but I only want to call extendTraces once
            if(pUpdateCounter >= 6) {
                pUpdateCounter = 0
                Plotly.extendTraces('pyrolysis-thermo-graph', {
                    x: [[pyrolysisVals[0]],[pyrolysisVals[0]],[pyrolysisVals[0]],[pyrolysisVals[0]],[pyrolysisVals[0]],[pyrolysisVals[0]]],
                    y: [[pyrolysisVals[1]],[pyrolysisVals[2]],[pyrolysisVals[3]],[pyrolysisVals[4]],[pyrolysisVals[5]],[pyrolysisVals[6]]]
                }, [0, 1, 2, 3, 4, 5])
            }

            if(document.getElementById('pyrolysis-tracking').textContent == 'Tracking Data...') {
                trackData(document.getElementById('pyrolysis-tracking-amount').value, 'pyrolysis-thermo-graph')
            }
            if(document.getElementById('bio-thermo-tracking').textContent == 'Tracking Data...') {
                trackData(document.getElementById('bio-thermo-tracking-amount').value, 'bio-thermo-graph')
            }
            if(document.getElementById('bio-ph-tracking').textContent == 'Tracking Data...') {
                trackData(document.getElementById('bio-ph-tracking-amount').value, 'bio-ph-graph')
            }
            if(document.getElementById('bio-oxygen-tracking').textContent == 'Tracking Data...') {
                trackData(document.getElementById('bio-oxygen-tracking-amount').value, 'bio-oxygen-graph')
            }
            if(document.getElementById('bio-turbidity-tracking').textContent == 'Tracking Data...') {
                trackData(document.getElementById('bio-turbidity-tracking-amount').value, 'bio-turbidity-graph')
            }
            if(document.getElementById('chem-thermo-tracking').textContent == 'Tracking Data...') {
                trackData(document.getElementById('chem-thermo-tracking-amount').value, 'chem-thermo-graph')
            }
        }
    }, false);

    source.addEventListener('bioreactor-readings', function(e) {
        var bioVals = e.data.split(',')
        
        let ids = Object.keys(bioGaugeInfo)
        ids.forEach((id) => {
            Plotly.update(id, {
                value: bioVals[ids.indexOf(id)+1], 
                title: bioGaugeInfo[id].title, 
                'gauge.bar.color': "blue",
            })
        })

        bioGaugeInfo["bio-ph-gauge1"].value = bioVals[2]
        bioGaugeInfo["bio-ph-gauge2"].value = bioVals[6]
        updateBioPhGauge("bio-ph-gauge1")
        updateBioPhGauge("bio-ph-gauge2")

        //plot values
        if(logging) {
            bUpdateCounter += 1
            if(bUpdateCounter >= 6) {
                bUpdateCounter = 0
                Plotly.extendTraces('bio-thermo-graph', {
                    x: [[bioVals[0]],[bioVals[0]]],
                    y: [[bioVals[1]],[bioVals[5]]]
                }, [0, 1])
                Plotly.extendTraces('bio-ph-graph', {
                    x: [[bioVals[0]],[bioVals[0]]],
                    y: [[bioVals[2]],[bioVals[6]]]
                }, [0, 1])
                Plotly.extendTraces('bio-oxygen-graph', {
                    x: [[bioVals[0]],[bioVals[0]]],
                    y: [[bioVals[3]],[bioVals[7]]]
                }, [0, 1])
                Plotly.extendTraces('bio-turbidity-graph', {
                    x: [[bioVals[0]],[bioVals[0]]],
                    y: [[bioVals[4]],[bioVals[8]]]
                }, [0, 1])
            }
        }
    }, false)

    source.addEventListener('chemreactor-readings', function(e) {
        var chemVals = e.data.split(',')

        let ids = Object.keys(chemGaugeInfo)
        ids.forEach((id) => {
            chemGaugeInfo[id].value = chemVals[ids.indexOf(id)+1]
            updateChemGauge(id)
        })
        //Plotly.restyle('chem-thermo-gauge1', {value: chemVals[1], title: 'Thermocouple 1', 'gauge.bar.color': "blue"})

        if(logging) {
            cUpdateCounter += 1
            if(cUpdateCounter >= 6) {
                cUpdateCounter = 0
                Plotly.extendTraces('chem-thermo-graph', {
                    x: [[chemVals[0]]],
                    y: [[chemVals[1]]]
                }, [0])
            }
        }
    }, false)
}

var logging = false;
function setRunning() {
    logging = !logging
    if(logging) {
        document.getElementById("run").textContent = "Logging Data..."
        sendPOST("logging", "logging")
    } else {
        document.getElementById("run").textContent = "Start Logging Data"
        sendPOST("not logging", "not-logging")
    }
}

function setESTOP() {
    if(document.getElementById("estop").textContent == 'E-STOP OFF') {
        document.getElementById("estop").textContent = 'E-STOP ON'
        sendPOST("estop on", "estop-on")
    } else {
        document.getElementById("estop").textContent = 'E-STOP OFF'
        sendPOST("estop off", "estop-off")
    }
}

function sendPOST(data, action) {
    var url = window.location.href + action;
    fetch(url, {
        method: "POST",
        headers: {
        'Content-Type': 'text/plain',
        },
        body: String(data),
    })
    .then(response => response.text()) // Get the response as text
    .then(textData => {
        // Handle the data from the response
        //console.log('Response Data:', textData);
    })
}

function setTracking(buttonID, inputID, graphID) {
    if(document.getElementById(buttonID).textContent == 'Track Data') {
        document.getElementById(buttonID).textContent = 'Tracking Data...'
        trackData(document.getElementById(inputID).value, graphID)
    } else {
        document.getElementById(buttonID).textContent = 'Track Data'
    }
}
function trackData(amount, graphID) {
    let lastIndex = pyrolysis_traces[0].x.length-1
    let currentDate = new Date(pyrolysis_traces[0].x[lastIndex])
    Plotly.relayout(graphID, {"xaxis.range": [currentDate - amount*1000, currentDate]})
}

function setGaugeValue(amount, gaugeID) {
    Plotly.update(gaugeID, {value: amount > 100 ? 100 : amount, title: motorGaugeInfo[gaugeID].title})
}

function updatePyrolysisGauge(gaugeID) {
    let setpoint = parseInt(pyrolysisGaugeInfo[gaugeID].setpoint)
    let value = parseInt(pyrolysisGaugeInfo[gaugeID].value)
    function pickColor() {
        if      (value < setpoint-50)   {return "yellow"}
        else if (value > setpoint+50)   {return "red"}
        else                            {return "green"}
    }
    let new_thermo_gauge = {
        domain: { x: [0, 1], y: [0, 1] },
        value: value,
        title: { text: pyrolysisGaugeInfo[gaugeID].title },
        type: "indicator",
        mode: "gauge+number",
        gauge: {
            axis: { range: [0, setpoint*2] },
            bar: { color: pickColor() },
            steps: [
                { range: [0, setpoint*2], color: "#dddddd" },
                { range: [setpoint*(1-0.275), setpoint*(1-0.225)], color: "yellow" },
                { range: [setpoint-(setpoint/40), setpoint+(setpoint/40)], color: "green" },
                { range: [setpoint*(1+0.275), setpoint*(1+0.225)], color: "red" }
            ],
        }
    };
    Plotly.restyle(gaugeID, new_thermo_gauge)
}

function updateChemGauge(gaugeID) {
    let setpoint = parseInt(chemGaugeInfo[gaugeID].setpoint)
    let value = parseInt(chemGaugeInfo[gaugeID].value)
    function pickColor() {
        if      (value < setpoint-50)   {return "yellow"}
        else if (value > setpoint+50)   {return "red"}
        else                            {return "green"}
    }
    let new_thermo_gauge = {
        domain: { x: [0, 1], y: [0, 1] },
        value: value,
        title: { text: chemGaugeInfo[gaugeID].title },
        type: "indicator",
        mode: "gauge+number",
        gauge: {
            axis: { range: [0, setpoint*2] },
            bar: { color: pickColor() },
            steps: [
                { range: [0, setpoint*2], color: "#dddddd" },
                { range: [setpoint*(1-0.275), setpoint*(1-0.225)], color: "yellow" },
                { range: [setpoint-(setpoint/40), setpoint+(setpoint/40)], color: "green" },
                { range: [setpoint*(1+0.275), setpoint*(1+0.225)], color: "red" }
            ],
        }
    };
    Plotly.restyle(gaugeID, new_thermo_gauge)
}

function updateBioPhGauge(gaugeID) {
    let setpoint = parseInt(bioGaugeInfo[gaugeID].setpoint)
    let value = parseInt(bioGaugeInfo[gaugeID].value)
    
    let new_ph_gauge = {
        domain: { x: [0, 1], y: [0, 1] },
        value: value,
        title: { text: bioGaugeInfo[gaugeID].title },
        type: "indicator",
        mode: "gauge+number",
        gauge: {
            axis: { range: [null, 14] },
            bar: { color: "blue" },
            steps: [
                { range: [0, 14], color: "#dddddd" },
            ],
            threshold: {
                line: { color: "red", width: 4 },
                thickness: 0.75,
                value: setpoint,
            }
        }
    }
    Plotly.restyle(gaugeID, new_ph_gauge)
}

function downloadCSVFile(url, filename) {
    // Create a hidden anchor element
    const anchor = document.createElement('a');
    anchor.style.display = 'none';
    document.body.appendChild(anchor);

    // Set the href attribute of the anchor element to the CSV file URL
    anchor.href = url;

    // Set the download attribute to specify the filename
    anchor.setAttribute('download', filename);

    // Trigger a click event on the anchor element to start the download
    anchor.click();

    // Clean up by removing the anchor element
    document.body.removeChild(anchor);
}

function clearPyrolysis() {
    sendPOST('delete-pyrolysis', 'delete-pyrolysis')

    for(let x = 0; x < pyrolysis_traces.length; x++) {
        pyrolysis_traces[x].x = []    //data[0] pushes time to the x axis
        pyrolysis_traces[x].y = []   //data[x+1] to avoid pushing the date and time
    }
    Plotly.newPlot('pyrolysis-thermo-graph', pyrolysis_traces, thermocouple_layout, {scrollZoom: true});
}

function clearBioreactor() {
    sendPOST('delete-bioreactor', 'delete-bioreactor')

    for(let x = 0; x < 2; x++) {
        bio_thermo_traces[x].x = []
        bio_ph_traces[x].x = []  
        bio_oxygen_traces[x].x = []
        bio_turbidity_traces[x].x = []

        bio_thermo_traces[x].y = []
        bio_ph_traces[x].y = []
        bio_oxygen_traces[x].y = []
        bio_turbidity_traces[x].y = []
    }
    Plotly.newPlot('bio-thermo-graph', bio_thermo_traces, bio_thermo_layout, {scrollZoom: true});                    
    Plotly.newPlot('bio-ph-graph', bio_ph_traces, pH_layout, {scrollZoom: true});
    Plotly.newPlot('bio-oxygen-graph', bio_oxygen_traces, oxygen_layout, {scrollZoom: true});
    Plotly.newPlot('bio-turbidity-graph', bio_turbidity_traces, turbidity_layout, {scrollZoom: true});
}

function clearChemreactor() {
    sendPOST('delete-chemreactor', 'delete-chemreactor')
    chem_thermo_traces[0].x = []
    chem_thermo_traces[0].y = []
    Plotly.newPlot('chem-thermo-graph', chem_thermo_traces, chem_thermo_layout, {scrollZoom: true});
}

</script>

</body>
</html>