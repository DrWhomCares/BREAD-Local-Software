<!DOCTYPE html>
<html>
<head>
    <script src="plotly.js"></script>
</head>

<body onload="loadData()">

    <h1>BREAD Configuration and Controls</h1>
    <button onclick="sendAllData()">Push All Data to Slices</button>
    <button id="run" onclick="setRunning()">Start Logging Data</button>
    <iframe name="target" style="display:none;"></iframe>
    <hr>

    <div id="pyrolysis">
        <h1>Pyrolysis Reactor</h1>

        <!-- Gauge area -->
        <div style="display: flex">
            <div>
                <div id="pyrolysis-thermo-gauge1"></div>
                <p>Status: ON/OFF (from slice) </p>
                <form action="/form-submit" method="POST" target="target">
                    <label for="pyrolysis-heater-1">Setpoint:</label>
                    <input type="number" name="pyrolysis-heater-1">
                    <button onclick="">Push Data</button>
                </form>
                <p>Kp: </p>
                <p>Ki: </p>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge2"></div>
                <p>Status: ON/OFF (from slice) </p>
                <form action="/form-submit" method="POST" target="target">
                    <label for="pyrolysis-heater-2">Setpoint:</label>
                    <input type="number" name="pyrolysis-heater-2">
                    <button onclick="">Push Data</button>
                </form>
                <p>Kp: </p>
                <p>Ki: </p>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge3"></div>
                <p>Status: ON/OFF (from slice) </p>
                <form action="/form-submit" method="POST" target="target">
                    <label for="pyrolysis-heater-3">Setpoint:</label>
                    <input type="number" name="pyrolysis-heater-3">
                    <button onclick="">Push Data</button>
                </form>
                <p>Kp: </p>
                <p>Ki: </p>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge4"></div>
                <p>Status: ON/OFF (from slice) </p>
                <form action="/form-submit" method="POST" target="target">
                    <label for="pyrolysis-heater-4">Setpoint:</label>
                    <input type="number" name="pyrolysis-heater-4">
                    <button onclick="">Push Data</button>
                </form>
                <p>Kp: </p>
                <p>Ki: </p>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge5"></div>
                <p>Status: ON/OFF (from slice) </p>
                <form action="/form-submit" method="POST" target="target">
                    <label for="pyrolysis-heater-5">Setpoint:</label>
                    <input type="number" name="pyrolysis-heater-5">
                    <button onclick="">Push Data</button>
                </form>
                <p>Kp: </p>
                <p>Ki: </p>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
            <div>
                <div id="pyrolysis-thermo-gauge6"></div>
                <p>Status: ON/OFF (from slice) </p>
                <form action="/form-submit" method="POST" target="target">
                    <label for="pyrolysis-heater-6">Setpoint:</label>
                    <input type="number" name="pyrolysis-heater-6">
                    <button onclick="">Push Data</button>
                </form>
                <p>Kp: </p>
                <p>Ki: </p>
                <p>Thermocouple #: </p>
                <p>Heater #: </p>
            </div>
        </div>

        <!-- Graph area -->
        <div id='pyrolysis-thermo-graph'></div>
        <label for="tracking-amount">Number of previous seconds to track: </label>
        <input type="number" id="tracking-amount" name="tracking-amount">
        <button id="tracking" onclick="setTracking()">Track Data</button>

        <br><br><br><br>
    </div>

    <div id="bioreactor">
        <h1>Bioreactor</h1>
        <div id="bio-thermocouples" style="display: flex">
            <div id="bio-thermo-gauge1"></div>
            <div id="bio-thermo-gauge2"></div>
            <div id="bio-thermo-graph" style="height: 350px; width: 1100px;"></div>
        </div>
       
        <div id="bio-ph" style="display: flex">
            <div id="bio-ph-gauge1"></div>
            <div id="bio-ph-gauge2"></div>
            <div id="bio-ph-graph" style="height: 350px; width: 1100px;"></div>
        </div>
        <div id="bio-oxygen" style="display: flex">
            <div id="bio-oxygen-gauge1"></div>
            <div id="bio-oxygen-gauge2"></div>
            <div id="bio-oxygen-graph" style="height: 350px; width: 1100px;"></div>
        </div>
        <div id="bio-motors-1" style="display: flex">
            <div id="bio-stirring-gauge1"></div>
            <div id="bio-pump1-gauge1"></div>
            <div id="bio-pump2-gauge1"></div>
            <div id="bio-pump3-gauge1"></div>
            <div id="bio-pump4-gauge1"></div>
            <div id="bio-pump5-gauge1"></div>
        </div>
        <div id="bio-motors-2" style="display: flex">
            <div id="bio-stirring-gauge2"></div>
            <div id="bio-pump1-gauge2"></div>
            <div id="bio-pump2-gauge2"></div>
            <div id="bio-pump3-gauge2"></div>
            <div id="bio-pump4-gauge2"></div>
            <div id="bio-pump5-gauge2"></div>
        </div>

    </div>

<script>

//----------------Pyrolysis thermocouple traces-----------------------//  
var pyrolysis_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Dissolution Tank"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Valve"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Char Chamber"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Pyrolysis Reactor"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Condenser 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Condenser 2"
    },
]

//----------------Bioreactor thermocouple traces-----------------------//
var bio_thermo_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Thermocouple 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Thermocouple 2"
    }
]

//----------------Bioreactor pH traces-----------------------//
var bio_ph_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "pH Sensor 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "pH Sensor 2"
    }
]

//----------------Bioreactor dissolved oxygen traces-----------------------//
var bio_oxygen_traces = [
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Dissolved Oxygen Sensor 1"
    },
    {
        y: [],
        x: [],
        type: 'scatter',
        mode: "lines",
        name: "Dissolved Oxygen Sensor 2"
    }
]

//----------------Thermocouple graph layout-----------------------//
var thermocouple_layout = {
    title: 'Temperature Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Degrees Celsius'
    },
    showlegend: true
};

//----------------pH graph layout-----------------------//
var pH_layout = {
    title: 'pH Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'pH'
    },
    showlegend: true
};

//----------------Dissolved oxygen graph layout-----------------------//
var oxygen_layout = {
    title: 'Dissolved Oxygen Data',
    xaxis: {
        title: 'Time',
        autorange: true,
        rangeselector: {buttons: [
            {
            count: 1,
            label: '1h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 6,
            label: '6h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 12,
            label: '12h',
            step: 'hour',
            stepmode: 'backward'
            },
            {
            count: 24,
            label: '24h',
            step: 'hour',
            stepmode: 'backward'
            },
            {step: 'all'}
        ]},
        type: 'date'
    },
    yaxis: {
        title: 'Dissolved Oxygen (mL)'
    },
    showlegend: true
};


function loadData() {
    //Get Data	
    fetch('data.csv')
    .then(response => response.text())
    .then(text => {
        let row = text.split("\r\n") //split entries by row

        for(let n = 1; n < row.length; n++) {
            let data = row[n].split(',')
            for(let x = 0; x < pyrolysis_traces.length; x++) {
                pyrolysis_traces[x].x.push(data[0])     //data[0] pushes time to the x axis
                pyrolysis_traces[x].y.push(data[x+1])   //data[x+1] to avoid pushing the date and time
            }
        }

        //Plot data
        Plotly.newPlot('pyrolysis-thermo-graph', pyrolysis_traces, thermocouple_layout, {scrollZoom: true});
        Plotly.newPlot('bio-thermo-graph', bio_thermo_traces, thermocouple_layout, {scrollZoom: true});                    
        Plotly.newPlot('bio-ph-graph', bio_ph_traces, pH_layout, {scrollZoom: true});
        Plotly.newPlot('bio-oxygen-graph', bio_oxygen_traces, oxygen_layout, {scrollZoom: true});                                       
    })

    //load bioreactor data


    //load chemreactor data


    //send time to ESP32
    var now = new Date();
    var rtcTime = now.toLocaleTimeString('en-US', {hour12: false}).split(":")
    rtcTime[2] = parseInt(rtcTime[2])
    var rtcDate = now.toLocaleDateString().split("/")
    fetch(window.location.href + "get-variables", {
        method: "POST",
        headers: {
        'Content-Type': 'text/plain',
        },
        body: rtcTime[2]+","+rtcTime[1]+","+rtcTime[0]+","+rtcDate[1]+","+rtcDate[0]+","+rtcDate[2],
    })
    .then(response => response.text()) // Get the response as text
    .then(textData => {
        if(textData == "logging") {
            logging = true;
            document.getElementById("run").textContent = "Logging Data..."
        } else if(textData == "not logging") {
            logging = false;
            document.getElementById("run").textContent = "Start Logging Data"
        }
    })
}

//----------------Standard Gauge Layout-----------------------//
var gaugeLayout = { width: 270, height: 220, margin: { t: 0, b: 0, l: 40, r: 40} };

//----------------Thermocouple Gauge-----------------------//
var thermo_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 200 },
    gauge: {
        axis: { range: [null, 400] },
        bar: { color: "blue" },
        steps: [
            { range: [0, 400], color: "#dddddd" },
            { range: [95, 105], color: "yellow" },
            { range: [195, 205], color: "green" },
            { range: [295, 305], color: "red" }
        ],
    }
}];

//----------------pH Gauge-----------------------//
var pH_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 7 },
    gauge: {
        axis: { range: [null, 14] },
        bar: { color: "green" },
        steps: [
            { range: [0, 14], color: "#dddddd" },
        ],
        threshold: {
            line: { color: "red", width: 4 },
            thickness: 0.75,
            value: 7
        }
    }
}];

//----------------Dissolved Oxygen Gauge-----------------------//
var oxygen_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 50 },
    gauge: {
        axis: { range: [null, 100] },
        bar: { color: "green" },
        steps: [
            { range: [0, 100], color: "#dddddd" },
        ],
    }
}];

//----------------Motor Gauge-----------------------//
var motor_gauge = [{
    domain: { x: [0, 1], y: [0, 1] },
    value: 0,
    title: { text: "" },
    type: "indicator",
    mode: "gauge+number",
    delta: { reference: 50 },
    gauge: {
        axis: { range: [null, 100] },
        bar: { color: "green" },
        steps: [
            { range: [0, 100], color: "#dddddd" },
        ],
    }
}];

//----------------Pyrolysis Gauges-----------------------//
//create new gauge plots
Plotly.newPlot('pyrolysis-thermo-gauge1', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge2', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge3', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge4', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge5', thermo_gauge, gaugeLayout);
Plotly.newPlot('pyrolysis-thermo-gauge6', thermo_gauge, gaugeLayout);

//adjust titles
Plotly.restyle('pyrolysis-thermo-gauge1', {title: "Dissolution Tank"})
Plotly.restyle('pyrolysis-thermo-gauge2', {title: "Valve"})
Plotly.restyle('pyrolysis-thermo-gauge3', {title: "Char Chamber"})
Plotly.restyle('pyrolysis-thermo-gauge4', {title: "Pyrolysis Reactor"})
Plotly.restyle('pyrolysis-thermo-gauge5', {title: "Condenser 1"})
Plotly.restyle('pyrolysis-thermo-gauge6', {title: "Condenser 2"})

//----------------Bioreactor Gauges-----------------------//
//create new gauge plots
Plotly.newPlot('bio-thermo-gauge1', thermo_gauge, gaugeLayout);
Plotly.newPlot('bio-thermo-gauge2', thermo_gauge, gaugeLayout);

Plotly.newPlot('bio-ph-gauge1', pH_gauge, gaugeLayout);
Plotly.newPlot('bio-ph-gauge2', pH_gauge, gaugeLayout);

Plotly.newPlot('bio-oxygen-gauge1', oxygen_gauge, gaugeLayout);
Plotly.newPlot('bio-oxygen-gauge2', oxygen_gauge, gaugeLayout);

Plotly.newPlot("bio-stirring-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-stirring-gauge2", motor_gauge, gaugeLayout);

Plotly.newPlot("bio-pump1-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump2-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump3-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump4-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump5-gauge1", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump1-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump2-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump3-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump4-gauge2", motor_gauge, gaugeLayout);
Plotly.newPlot("bio-pump5-gauge2", motor_gauge, gaugeLayout);

//restyle
Plotly.restyle('bio-thermo-gauge1', {title: "Thermocouple 1"})
Plotly.restyle('bio-thermo-gauge2', {title: "Thermocouple 2"})
Plotly.restyle('bio-ph-gauge1', {title: "pH Sensor 1"})
Plotly.restyle('bio-ph-gauge2', {title: "pH Sensor 2"})
Plotly.restyle('bio-oxygen-gauge1', {title: "Dissolved Oxygen 1"})
Plotly.restyle('bio-oxygen-gauge2', {title: "Dissolved Oxygen 2"})
Plotly.restyle('bio-stirring-gauge1', {title: "Stirring Motor 1"})
Plotly.restyle('bio-stirring-gauge2', {title: "Stirring Motor 2"})
Plotly.restyle('bio-pump1-gauge1', {title: "Pump 1-1"})
Plotly.restyle('bio-pump2-gauge1', {title: "Pump 1-2"})
Plotly.restyle('bio-pump3-gauge1', {title: "Pump 1-3"})
Plotly.restyle('bio-pump4-gauge1', {title: "Pump 1-4"})
Plotly.restyle('bio-pump5-gauge1', {title: "Pump 1-5"})
Plotly.restyle('bio-pump1-gauge2', {title: "Pump 2-1"})
Plotly.restyle('bio-pump2-gauge2', {title: "Pump 2-2"})
Plotly.restyle('bio-pump3-gauge2', {title: "Pump 2-3"})
Plotly.restyle('bio-pump4-gauge2', {title: "Pump 2-4"})
Plotly.restyle('bio-pump5-gauge2', {title: "Pump 2-5"})

//--------------------------------------------------------------------------//

if (!!window.EventSource) {
    var source = new EventSource('/events');

    source.addEventListener('open', function(e) {
        console.log("Events Connected");
    }, false);

    source.addEventListener('error', function(e) {
        if (e.target.readyState != EventSource.OPEN) {
            console.log("Events Disconnected");
        }
    }, false);

    source.addEventListener('thermocouple-readings', function(e) {
        var dataVals = e.data.split(',')

        function pickColor(val) {
            if      (val < 100){return "yellow"}
            else if (val > 300){return "red"}
            else               {return "green"}
        }
        
        var gaugeInfo = [
            {id: "pyrolysis-thermo-gauge1", value: dataVals[1], title: "Dissolution Tank"},
            {id: "pyrolysis-thermo-gauge2", value: dataVals[2], title: "Valve"},
            {id: "pyrolysis-thermo-gauge3", value: dataVals[3], title: "Char Chamber"},
            {id: "pyrolysis-thermo-gauge4", value: dataVals[4], title: "Pyrolysis Reactor"},
            {id: "pyrolysis-thermo-gauge5", value: dataVals[5], title: "Condenser 1"},
            {id: "pyrolysis-thermo-gauge6", value: dataVals[6], title: "Condenser 2"},
        ]
        
        //push values to gauges (need to change titles too for some reason to keep them there lol)
        for(let n = 0; n < gaugeInfo.length; n++) {
            Plotly.restyle(gaugeInfo[n].id, {value: gaugeInfo[n].value, title: gaugeInfo[n].title, 'gauge.bar.color': pickColor(gaugeInfo[n].value)})
        }
        
        //plot values
        if(logging) {
            //could use a for loop but I only want to call extendTraces once
            Plotly.extendTraces('pyrolysis-thermo-graph', {
                x: [[dataVals[0]],[dataVals[0]],[dataVals[0]],[dataVals[0]],[dataVals[0]],[dataVals[0]]],
                y: [[dataVals[1]],[dataVals[2]],[dataVals[3]],[dataVals[4]],[dataVals[5]],[dataVals[6]]]
            }, [0, 1, 2, 3, 4, 5])

            //Plotly.relayout("graph1", {rangeselector: {range: [pyrolysis_traces[0].x[0], pyrolysis_traces[0].x[pyrolysis_traces[0].x.length-1]]}})

            if(tracking) {
                trackData(document.getElementById('tracking-amount').value)
            }
        }
  }, false);
}

function sendAllData() {
    // URL to send the POST request to
    var url = window.location.href;

    var slices = document.querySelectorAll(".slice");
    var allData = []
    // Data to be sent in the POST request
    for(let x = 0; x < slices.length; x++) {
        var inputs = slices[x].querySelectorAll("input")
        for(let n = 0; n < inputs.length; n++) {
            allData.push(inputs[n].value)
        }
    }

    sendPOST(allData, "all-data")
}

var logging = false;
function setRunning() {
    logging = !logging
    if(logging) {
        document.getElementById("run").textContent = "Logging Data..."
        sendPOST("logging", "logging")
    } else {
        document.getElementById("run").textContent = "Start Logging Data"
        sendPOST("not logging", "not-logging")
    }
}

function sendPOST(data, action) {
    var url = window.location.href + action;
    fetch(url, {
        method: "POST",
        headers: {
        'Content-Type': 'text/plain',
        },
        body: String(data),
    })
    .then(response => response.text()) // Get the response as text
    .then(textData => {
        // Handle the data from the response
        //console.log('Response Data:', textData);
    })
}

var tracking = false;
function setTracking() {
    tracking = !tracking
    if(tracking) {
        document.getElementById('tracking').textContent = 'Tracking Data...'
        trackData(document.getElementById('tracking-amount').value)
    } else {
        document.getElementById('tracking').textContent = 'Track Data'
    }
}
function trackData(amount) {
    let lastIndex = pyrolysis_traces[0].x.length-1
    let currentDate = new Date(pyrolysis_traces[0].x[lastIndex])
    Plotly.relayout("pyrolysis-thermo-graph", {"xaxis.range": [currentDate - amount*1000, currentDate]})
}
</script>

</body>
</html>